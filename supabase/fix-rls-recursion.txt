-- Fix RLS Infinite Recursion for Admin Policies
-- Run this in your Supabase SQL Editor

-- Step 1: Drop the problematic policies that cause infinite recursion
drop policy if exists "Admins can view all profiles" on profiles;
drop policy if exists "Admins can update all profiles" on profiles;

-- Step 2: Create a security definer function that bypasses RLS
-- This prevents the infinite recursion by not triggering RLS when checking admin status
create or replace function is_admin()
returns boolean as $$
  select exists (
    select 1 from profiles
    where id = auth.uid() and is_admin = true
  );
$$ language sql security definer;

-- Step 3: Recreate admin policies using the new function
create policy "Admins can view all profiles"
  on profiles for select
  using (is_admin());

create policy "Admins can update all profiles"
  on profiles for update
  using (is_admin());

-- Step 4: Fix conversation and message policies too
drop policy if exists "Admins can view all conversations" on conversations;
drop policy if exists "Admins can delete any conversation" on conversations;
drop policy if exists "Admins can view all messages" on messages;

create policy "Admins can view all conversations"
  on conversations for select
  using (is_admin());

create policy "Admins can delete any conversation"
  on conversations for delete
  using (is_admin());

create policy "Admins can view all messages"
  on messages for select
  using (is_admin());
